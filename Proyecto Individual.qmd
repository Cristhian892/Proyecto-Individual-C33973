---
title: "Proyecto Individual"
author: "Cristhian Jimenez Campos"
format: html
editor: visual
---

```{r}
# Cargar librerías necesarias
library(gridExtra) # nos ayuda a poder mezclar gráficos y tablas
library(ggplot2) #lo usamos para generar las gráficas que se van a presentar
library(stringr) #Nos ayuda al manejo de cadenas de texto, etc.
library(haven) #La base de datos es .sav entonces se usó esta librería para poder cargarla
library(dplyr) #nos ayuda a transformar y utilizar data frame de manera eficaz, y legible
library(tidyr) #nos ayuda a transformar datos en formato tidy, ayudando la limpieza y demás
library(grid) #nos ayuda a crear elementos gráficos personalizados, posición, tamaño, etc.
library(gt) # con este lo usamos para generar tablas para presentación
library(plotly)
```

```{r}
#Se carga la base de datos que vamos a usar 
datos <- read_sav("DEFU2022.sav")

#'Se van a quitar columnas que para el caso de estudio son innecesarias y así no pasamos
#' de 32 columnas a 15, las cuales vamos a usar algunas para este proyecto
datos_filtrados <- datos %>% 
   select(-any_of(c("anotrab", 
                    "mestrab", 
                    "edadsrec", 
                    "pcd",
                    "IU", 
                    "autopsia", 
                    "asistmed", 
                    "instmurio", 
                    "ocuparec", 
                    "provregis",
                    "pcregis",
                    "diadeclara",
                    "mesdeclara", 
                    "anodeclara",
                    "grgruposcb",
                    "gruposcb",
                    "reginec", 
                    "regsalud")))

#Sacamos la cantidad de muertes por provincia 
muertes_privincia <- datos_filtrados %>% #Selecciona los datos que se han filtrado
   group_by(provincia, sexo) %>% #Los agrupa por provincia, además también por sexo, ya que se van a diferenciar también en esto
   summarise(total_nuertes = n(), .groups = "drop") #Cuando se realiza la agrupación, se realiza un conteo de muertes por provincia, además de eso se va a desglosar las muertes, según el sexo, mostrando por provincia y se distribuye por género.
```

```{r}
#Las 5 principales causas de defunción por provincia
muertes_5_causas <- datos_filtrados %>% #Selecciona los datos que se han filtrado
   group_by(provincia, sexo, causamuer, des_causa) %>% #Se agrupa por provincia, sexo, causamuer y des_causa
   summarise(total = n(), .groups = "drop") %>% #Cuenta el número de muertes y remueve la agrupacion
   arrange(provincia, sexo, desc(total)) %>% #Se ordena en los resultados en provincia, sexo y en total, para mantener el orden lo acomoda de manera descendente
   group_by(provincia, sexo) %>% #Agrupa por provincia y sexo para obtener las principales causas en cada grupo
   slice_head(n=5) #Esto selecciona las 5 causas de muerte, 5 por hombres y 5 por mujeres

#datos por año

dato_año <- datos_filtrados %>% #Selecciona los datos que se han filtrado
   group_by(provincia, sexo, causamuer, des_causa) %>% #Se agrupa por provincia, sexo, causamuer y des_causa 
   summarise(total = n(), .groups = "drop") 

for (prov in unique(datos_filtrados$provincia)) { #itera sobre las provincias únicas en datos_filtrados
  for (sexo_actual in c("1", "2")) {#se itera sobre los valores de sexo "1" y "2"
   
     # Filtrar las 5 causas según provincia, sexo y se ordena de mayor a menor con la columna total
    causa_prov <- muertes_5_causas %>% 
      filter(provincia == prov, as.character(sexo) == sexo_actual) %>% 
      arrange(desc(total)) %>% 
      slice_head(n = 5) #selecciona solo las primeras  5 filas
    
     #Esto es creado para ser usado por la la tabla y solo usar el des_causa
     causa_prov_informacion <- causa_prov %>% pull(des_causa)
     
     #se crea una plantilla para el cuadro de información
     tbl_theme <- ttheme_default(
        core = list(fg_params = list(hjust = 0, x = 0.01, fontsize = 9)), #Texto del cuerpo de la tabla
        colhead = list(fg_params = list(hjust = 0, x = 0.01, fontsize = 10)), #Encabezado de columnas
        rowhead = list(fg_params = list(hjust = 0, x = 0.01, fontsize = 9)) #Encabezado de columnas
      )

     tabla_grob <- tableGrob(
       data.frame(`Causas de Muerte` = causa_prov_informacion), # se crea un objeto tabla para las causas de muerte filtradas
       rows = NULL, #No se asigna nombres a las filas de la tabla
       theme = tbl_theme) # aplica el tema que se creó anteriormente 
     
     #ayuda a ajustar la altura de todas las filas de la tabla, para mejor aspecto visual
     tabla_grob$heights <- unit(rep(0.7, length(tabla_grob$heights)), "lines")
      
     datos_prov_anual_sexo <- dato_año %>%
       filter(provincia == prov, as.character(sexo) == sexo_actual, causamuer %in%  causa_prov$causamuer) %>% #filtra filas para la provincia actual, sexo actual, e incluye las causas de muerte
       mutate(
         causamuer = as.character(causamuer), # Pasa a causamuer a caracter para evitar errores
         sexo = as.character(sexo),# lo mismo con sexo
         sexo = case_when( #le da a los valres de sexo nombres para una mejor comprencion
           sexo == "1" ~ "Hombre",
           sexo == "2" ~ "Mujer",
           TRUE ~ sexo #para otros valores los deja sin modificar
           ),
         causaunuer = factor(causamuer, levels = causa_prov$causamuer) # crea y ordena segun las causas filtradas
         )
     
     # Gráfico con ggplot2 y muestra las muertes por causa segun el sexo y la privincia 
     plot_grafico <- ggplot(datos_prov_anual_sexo, aes(x = causamuer, y = total)) +
       geom_bar(stat = "identity", fill = ifelse(sexo_actual == "1", "#1f77b4", "#CD3333")) +
       
       #le asigna coloresa la grafica segun si es hombre o mujer
       coord_flip() + # invierte los ejes para que causa salga en el ejer vertical
       scale_x_discrete() + # escala discreta para las causa de muerte eje x
       scale_y_continuous(breaks = seq(0, max(datos_prov_anual_sexo$total), 20))+ #escala para el eje y y los saltos de cada 20 muertos 
       labs(
         title = paste("Las 5 causas de muerte para", #Titulo dinamico con sexo y provincia
                       ifelse(sexo_actual == "1", "Hombres", "Mujeres"), 
                       "en", prov),
         x = "Causa de muerte",  
         y = "Número de muertes"
         ) +
       theme_minimal() + # 
       theme(legend.position = "none") # 
    
     # Combinar la gráfica y la tabla creada arriba en un solo output
     grid.arrange(plot_grafico, tabla_grob, ncol = 1, heights = c(3, 1))
     }
  }
```

```{r}
# defunciones por provincias y sexo de manera anual
muertes_privincia <- datos_filtrados %>%
   group_by(provincia, sexo, causamuer) %>%
   summarise(total_nuertes = n(), .groups = "drop")
```

```{r}
nombres_meses <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                   "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")

# analisis mensual, por medio del mes.
resultados_mensuales <- datos_filtrados %>%
  group_by(mesdef, sexo, causamuer, des_causa) %>%
  summarise(total_muertes = n(), .groups = "drop") %>%
  group_by(mesdef, sexo) %>%
  arrange(mesdef, sexo, desc(total_muertes)) %>%
  slice_head(n = 5) %>%
  ungroup() %>%
  mutate(
    sexo = case_when(
      sexo == 1 ~ "Hombre",
      sexo == 2 ~ "Mujer",
      TRUE ~ as.character(sexo)
    ),
    mes = factor(nombres_meses[mesdef], levels = nombres_meses)  
  ) 
```

```{r}
#Gráfica por mes, de la cantidad de defunciones de hombres y mujeres.
ggplot(resultados_mensuales, aes(x = mes, y = total_muertes, fill = sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Total de muertes por mes y sexo",
    x = "Mes",
    y = "Total de muertes",
    fill = "sexo"
  ) +
  scale_fill_manual(values = c("Hombre" = "#1f77b4", "Mujer" = "#CD3333", "Otro" = "red")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1), # se tomó la decisión de poner los nombres de los meses, si el ángulo es de 45 la lectura es borrosa, si es de 0, algunos se solapan, entonces se puso un ángulo de 90
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```








